services:
  # ==============================================================================
  # Unified SeerrBridge Container
  # Includes: MySQL + Python Backend + Nuxt Frontend
  # Uses pre-built image from GitHub Container Registry
  # ==============================================================================
  seerrbridge:
    image: ghcr.io/woahai321/seerrbridge:latest
    container_name: seerrbridge
    restart: unless-stopped
    environment:
      # MySQL Configuration
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-seerrbridge_root}
      DB_HOST: localhost
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-seerrbridge}
      DB_USER: ${DB_USER:-seerrbridge}
      DB_PASSWORD: ${DB_PASSWORD:-seerrbridge}
      USE_DATABASE: "true"
      
      # Python Configuration
      PYTHONUNBUFFERED: "1"
      PYTHONDONTWRITEBYTECODE: "1"
      
      # Nuxt Configuration
      NODE_ENV: production
      NUXT_HOST: 0.0.0.0
      NUXT_PORT: 3777
      SEERRBRIDGE_URL: http://localhost:8777
      SETUP_API_URL: http://localhost:8778
      SEERRBRIDGE_SETUP_URL: http://localhost:8778
      
      # Note: All configuration (API keys, tokens, advanced settings, etc.)
      # is managed via the web interface and stored in .env file.
    ports:
      - "3307:3306"  # MySQL (exposed on 3307 to avoid conflicts with local MySQL)
      - "3777:3777"  # Nuxt frontend
      - "8777:8777"  # SeerrBridge API
      - "8778:8778"  # Setup API server
    volumes:
      - mysql_data:/var/lib/mysql  # MySQL data persistence
      - ./logs:/app/logs  # Log files
      - ./data:/app/data  # Application data (includes .env file)
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:8777/status && curl -f http://localhost:3777/api/health || exit 1"]
      timeout: 10s
      retries: 5
      interval: 30s
      start_period: 120s

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  mysql_data:
    driver: local
    name: seerrbridge_mysql_data
